{"version":3,"file":"contact-form.astro.mjs","sources":["../../../src/scripts-ssr/env.ts","../../../src/pages/contact-form.ts"],"sourcesContent":["export function getEnv(\n    locals: App.Locals,\n    metaEnv: ImportMetaEnv,\n    name: string\n) {\n    const env = import.meta.env.PROD ? locals.runtime.env : metaEnv;\n\n    if (!env[name]) throw new Error(`Missing environment variable \"${name}\"`);\n\n    return env[name];\n}\n","import type { APIRoute } from \"astro\";\nimport { getEnv } from \"../scripts-ssr/env\";\n\nfunction isNonEmptyString(value: unknown): value is string {\n    return typeof value === \"string\" && value.length > 0;\n}\n\nexport const put: APIRoute = async ({ request, locals }) => {\n    const data = await request.formData();\n    const name = data.get(\"name\");\n    const email = data.get(\"email\");\n    const message = data.get(\"message\");\n\n    if (!isNonEmptyString(name) || !isNonEmptyString(message))\n        return new Response(null, {\n            status: 400,\n        });\n\n    const header = `**From ${name.trim()} ${\n        isNonEmptyString(email) ? `<${email.trim()}>` : \"\"\n    }**`;\n\n    const text = message.trim();\n    const content = header + \"\\n\\n\" + text;\n\n    if (header.length > 2000 || content.length > 10_500)\n        return new Response(null, { status: 400 });\n\n    const msgData = {\n        allowed_mentions: {\n            parse: [],\n        },\n        content: content.length > 2000 ? header : content,\n    };\n\n    const payload = new FormData();\n    payload.set(\"payload_json\", JSON.stringify(msgData));\n\n    if (text.length > 2000)\n        payload.set(\n            \"files[0]\",\n            new Blob([text], { type: \"text/plain\" }),\n            \"message.txt\"\n        );\n\n    const url = new URL(getEnv(locals, import.meta.env, \"CONTACT_WEBHOOK\"));\n    url.searchParams.set(\"wait\", \"true\");\n\n    const res = await fetch(url, {\n        method: \"POST\",\n        body: payload,\n    });\n\n    if (!res.ok) {\n        console.error(\n            \"Error while executing contact webhook:\",\n            res.status,\n            \"\\n\" + (await res.text().catch(() => \"Unknown error\"))\n        );\n\n        return new Response(\"Failed to post message\", {\n            status: 502,\n        });\n    }\n\n    return new Response(null, {\n        status: 201,\n    });\n};\n"],"names":[],"mappings":"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"}